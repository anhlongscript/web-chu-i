<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Streaky - Demo</title>
<style>
  :root{--bg:#fff;--accent:#f6b93b;--accent-dark:#f0a500;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:#111}
  header{padding:16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eee}
  header h1{margin:0; font-size:18px}
  .container{padding:18px}
  /* Tabs */
  .tabs{display:flex; gap:10px; margin-bottom:12px}
  .tab{padding:8px 12px; border-radius:20px; background:#f5f5f5; cursor:pointer}
  .tab.active{background:var(--accent); color:#fff}
  /* main card */
  .card{background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.05); padding:18px; margin-bottom:14px}
  .center{text-align:center}
  #fire{font-size:84px; transition:color .3s}
  .progress-wrap{width:320px; height:16px; margin:10px auto; border-radius:12px; overflow:hidden; border:1px solid #eee}
  #progress{height:100%; width:0%; background:linear-gradient(90deg,#ff7a00,#ffcf33); transition:width .5s}
  button.primary{background:var(--accent); color:#111; border:none; padding:10px 18px; border-radius:30px; cursor:pointer; font-weight:600}
  button.ghost{background:transparent; border:1px solid #ddd; padding:8px 12px; border-radius:10px; cursor:pointer}
  .muted{color:var(--muted); font-size:14px}
  .row{display:flex; gap:12px; align-items:center; justify-content:center}
  .small{font-size:13px}
  .badge{background:red;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;display:inline-block;margin-left:6px}
  /* bottom nav */
  nav.bottom{position:fixed; left:0; right:0; bottom:0; height:64px; display:flex; justify-content:space-around; align-items:center; background:#fff;border-top:1px solid #eee}
  nav .item{display:flex;flex-direction:column;align-items:center;font-size:12px; color:#444}
  nav .item.active{color:var(--accent)}
  /* lists */
  .user-list{display:flex;flex-direction:column; gap:8px}
  .user-row{display:flex;align-items:center;gap:12px;padding:8px;border-radius:10px; border:1px solid #f0f0f0}
  .avatar{width:44px;height:44px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:20px}
  .flex{flex:1}
  .right{margin-left:auto}
  .settings{position:absolute; right:16px; top:16px}
  /* modal */
  .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:50}
  .modal{width:360px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .row-between{display:flex;justify-content:space-between;align-items:center}
  input[type="text"],input[type="password"],select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px}
  .small-muted{font-size:12px;color:#777}
  .topbar-right{display:flex;gap:8px;align-items:center}
  .notify{position:relative;cursor:pointer}
  .notify .badge-pos{position:absolute;right:-6px;top:-6px}
  /* responsive */
  @media (max-width:420px){
    .modal{width:92%}
    #fire{font-size:64px}
    .progress-wrap{width:92%}
  }
</style>
</head>
<body>

<header>
  <h1>Streaky</h1>
  <div class="topbar-right">
    <div class="notify" id="notifBtn" title="ThÃ´ng bÃ¡o">ğŸ“© <span id="notifBadge" class="badge badge-pos" style="display:none">0</span></div>
    <div id="settingsBtn" class="settings">âš™ï¸</div>
  </div>
</header>

<div class="container">

  <!-- LOGIN / REGISTER -->
  <div id="authArea" class="card">
    <div id="authForms">
      <div id="loginForm">
        <h3>ÄÄƒng nháº­p</h3>
        <input id="loginUser" placeholder="TÃªn ngÆ°á»i dÃ¹ng" />
        <input id="loginPass" type="password" placeholder="Máº­t kháº©u" />
        <div style="height:10px"></div>
        <div class="row" style="justify-content:center">
          <button id="btnLogin" class="primary">ÄÄƒng nháº­p</button>
          <button id="showRegister" class="ghost">ÄÄƒng kÃ½</button>
        </div>
        <div class="muted center small">ChÆ°a cÃ³ tÃ i khoáº£n? Nháº¥n ÄÄƒng kÃ½</div>
      </div>

      <div id="registerForm" style="display:none">
        <h3>ÄÄƒng kÃ½</h3>
        <input id="regName" placeholder="TÃªn hiá»ƒn thá»‹" />
        <input id="regPass" type="password" placeholder="Máº­t kháº©u" />
        <div style="height:8px"></div>
        <label>Giá»›i tÃ­nh</label>
        <select id="regGender">
          <option value="male">Nam</option>
          <option value="female">Ná»¯</option>
        </select>
        <div style="height:8px"></div>
        <label>Avatar (chá»n file)</label>
        <input id="regAvatar" type="file" accept="image/*" />
        <div style="height:8px"></div>
        <div class="row" style="justify-content:center">
          <button id="btnRegister" class="primary">ÄÄƒng kÃ½</button>
          <button id="showLogin" class="ghost">Quay láº¡i</button>
        </div>
        <div id="regMsg" class="small-muted center"></div>
      </div>
    </div>
  </div>

  <!-- APP AREA -->
  <div id="appArea" style="display:none">
    <!-- CHÆ¯ÌƒI TAB -->
    <div class="tabs">
      <div class="tab active" data-tab="streak">Chuá»—i</div>
      <div class="tab" data-tab="explore">KhÃ¡m phÃ¡</div>
      <div class="tab" data-tab="leader">Báº£ng xáº¿p háº¡ng</div>
      <div class="tab" data-tab="me">TÃ´i</div>
    </div>

    <!-- Streak tab -->
    <div id="streak" class="card">
      <div class="center">
        <div id="fire">ğŸ”¥</div>
        <div id="progressWrap" class="progress-wrap"><div id="progress"></div></div>
        <div id="streakText" class="muted small">Streak: 0 ngÃ y</div>
        <div style="height:12px"></div>

        <div id="lockedMsg" style="display:none" class="muted">
          ğŸ”’ Báº¡n chÆ°a cÃ³ báº¡n tham gia. Vui lÃ²ng má»i 1 ngÆ°á»i Ä‘á»ƒ má»Ÿ khÃ³a Ä‘iá»ƒm danh.
        </div>

        <div id="btnsRow" class="row" style="margin-top:10px">
          <button id="checkinBtn" class="primary">Äiá»ƒm danh</button>
          <button id="invitePlus" class="ghost">â• Má»i báº¡n</button>
        </div>

        <div id="checkinMsg" class="muted small" style="margin-top:10px"></div>

      </div>
      <div style="height:12px"></div>
      <div class="small-muted">Báº¡n bÃ¨ tham gia:</div>
      <div id="friendsList" class="user-list" style="margin-top:8px"></div>
    </div>

    <!-- Explore tab -->
    <div id="explore" class="card" style="display:none">
      <h3>Äá» xuáº¥t</h3>
      <div id="suggestions" class="user-list"></div>
      <h3 style="margin-top:12px">Báº¡n cá»§a báº¡n</h3>
      <div id="myFriends" class="user-list"></div>
    </div>

    <!-- Leaderboard -->
    <div id="leader" class="card" style="display:none">
      <h3>Top Streak</h3>
      <div id="leaderboard" class="user-list"></div>
    </div>

    <!-- Me -->
    <div id="me" class="card" style="display:none; position:relative">
      <div style="display:flex;gap:12px;align-items:center">
        <div id="myAvatar" class="avatar">ğŸ™‚</div>
        <div>
          <div id="myName" style="font-weight:700">TÃªn</div>
          <div id="myGender" class="muted small">Giá»›i tÃ­nh</div>
        </div>
        <div class="right">
          <button id="logoutBtn" class="ghost">ÄÄƒng xuáº¥t</button>
        </div>
      </div>
      <div style="height:12px"></div>
      <div>
        <button id="openSettings" class="ghost">âš™ï¸ CÃ i Ä‘áº·t</button>
      </div>
    </div>

  </div>
</div>

<!-- MODALS -->
<div id="modalBg" class="modal-bg">
  <div class="modal" id="modalContent"></div>
</div>

<script>
/* ---------- Utilities & Data storage (localStorage mock DB) ---------- */
function uid(){ return Math.random().toString(36).slice(2,9) }
function now(){ return Date.now() }

// load users list from localStorage
function loadUsers(){
  return JSON.parse(localStorage.getItem('st_users')||'[]')
}
function saveUsers(list){
  localStorage.setItem('st_users', JSON.stringify(list))
}

// current logged in user id
function getCurrentId(){ return localStorage.getItem('st_current') }
function setCurrentId(id){ localStorage.setItem('st_current', id) }
function clearCurrent(){ localStorage.removeItem('st_current') }

// init some demo users if none
if(!localStorage.getItem('st_users')){
  const demo = [
    {id:uid(),name:'Huy',gender:'male',pass:'123',avatar:'ğŸ‘¦',streak:45,lastCheckin: now()-2*86400000, friends:[], invites:[]},
    {id:uid(),name:'Lan',gender:'female',pass:'123',avatar:'ğŸ‘§',streak:30,lastCheckin: now()-3*86400000, friends:[], invites:[]},
    {id:uid(),name:'Minh',gender:'male',pass:'123',avatar:'ğŸ§‘',streak:15,lastCheckin: now()-1*86400000, friends:[], invites:[]}
  ]
  saveUsers(demo)
}

/* ---------- DOM references ---------- */
const authArea = document.getElementById('authArea')
const appArea = document.getElementById('appArea')
const notifBtn = document.getElementById('notifBtn')
const notifBadge = document.getElementById('notifBadge')
const modalBg = document.getElementById('modalBg')
const modalContent = document.getElementById('modalContent')

/* Auth elements */
const loginUser = document.getElementById('loginUser')
const loginPass = document.getElementById('loginPass')
const btnLogin = document.getElementById('btnLogin')
const showRegister = document.getElementById('showRegister')
const registerForm = document.getElementById('registerForm')
const loginForm = document.getElementById('loginForm')
const showLogin = document.getElementById('showLogin')
const btnRegister = document.getElementById('btnRegister')
const regName = document.getElementById('regName')
const regPass = document.getElementById('regPass')
const regGender = document.getElementById('regGender')
const regAvatar = document.getElementById('regAvatar')
const regMsg = document.getElementById('regMsg')

/* App elements */
const tabs = Array.from(document.querySelectorAll('.tab'))
const fireEl = document.getElementById('fire')
const progressEl = document.getElementById('progress')
const streakText = document.getElementById('streakText')
const checkinBtn = document.getElementById('checkinBtn')
const invitePlus = document.getElementById('invitePlus')
const lockedMsg = document.getElementById('lockedMsg')
const checkinMsg = document.getElementById('checkinMsg')
const friendsList = document.getElementById('friendsList')
const suggestionsEl = document.getElementById('suggestions')
const myFriendsEl = document.getElementById('myFriends')
const leaderboardEl = document.getElementById('leaderboard')
const myAvatar = document.getElementById('myAvatar')
const myName = document.getElementById('myName')
const myGender = document.getElementById('myGender')
const logoutBtn = document.getElementById('logoutBtn')
const openSettings = document.getElementById('openSettings')

/* modal helpers */
function showModal(html){
  modalContent.innerHTML = html
  modalBg.style.display = 'flex'
}
function closeModal(){ modalBg.style.display = 'none' }
modalBg.addEventListener('click', (e)=>{ if(e.target===modalBg) closeModal() })

/* notifications */
function countNotificationsForCurrent(){
  const id = getCurrentId()
  if(!id) return 0
  const users = loadUsers()
  const me = users.find(u=>u.id===id)
  return me && me.invites ? me.invites.length : 0
}
function updateNotifBadge(){
  const c = countNotificationsForCurrent()
  if(c>0){ notifBadge.style.display='inline-block'; notifBadge.textContent=c } else { notifBadge.style.display='none' }
}

/* ---------- Auth logic ---------- */
showRegister.addEventListener('click', ()=>{ loginForm.style.display='none'; registerForm.style.display='block' })
showLogin.addEventListener('click', ()=>{ loginForm.style.display='block'; registerForm.style.display='none' })

btnRegister.addEventListener('click', async ()=>{
  const name = regName.value.trim()
  const pass = regPass.value.trim()
  const gender = regGender.value
  if(!name || !pass){ regMsg.textContent='Vui lÃ²ng Ä‘iá»n tÃªn vÃ  máº­t kháº©u'; return }
  // avatar file to emoji fallback (for demo we use first letter or file preview)
  let avatar = name[0] ? name[0].toUpperCase() : 'ğŸ™‚'
  if(regAvatar.files && regAvatar.files[0]){
    // convert to base64 small
    const file = regAvatar.files[0]
    avatar = await new Promise(resolve=>{
      const r = new FileReader()
      r.onload = ()=>resolve(r.result)
      r.readAsDataURL(file)
    })
  }
  const users = loadUsers()
  if(users.some(u=>u.name===name)){ regMsg.textContent='TÃªn nÃ y Ä‘Ã£ tá»“n táº¡i'; return }
  const id = uid()
  users.push({id,name,gender,pass,avatar,streak:0,lastCheckin:0,friends:[],invites:[]})
  saveUsers(users)
  regMsg.textContent='ÄÄƒng kÃ½ thÃ nh cÃ´ng! Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p.'
  // auto login
  setTimeout(()=>{ setCurrentId(id); renderApp(); }, 600)
})

btnLogin.addEventListener('click', ()=>{
  const name = loginUser.value.trim()
  const pass = loginPass.value.trim()
  const users = loadUsers()
  const u = users.find(x=>x.name===name && x.pass===pass)
  if(!u){ alert('Sai tÃªn hoáº·c máº­t kháº©u (demo: thá»­ tÃªn Huy/123)'); return }
  setCurrentId(u.id)
  renderApp()
})

logoutBtn.addEventListener('click', ()=>{
  clearCurrent()
  location.reload()
})

/* ---------- App render ---------- */
function renderApp(){
  const cur = getCurrentId()
  if(!cur){ authArea.style.display='block'; appArea.style.display='none'; updateNotifBadge(); return }
  authArea.style.display='none'; appArea.style.display='block'
  updateNotifBadge()
  renderTabs('streak')
  renderUserInfo()
  renderSuggestions()
  renderFriends()
  renderLeaderboard()
}

/* Tabs click */
tabs.forEach(t=>{
  t.addEventListener('click', ()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderTabs(t.dataset.tab) })
})

function renderTabs(tab){
  // hide all card areas
  document.querySelectorAll('#streak,#explore,#leader,#me').forEach(x=>x.style.display='none')
  document.getElementById(tab).style.display='block'
  // update streak UI each time
  updateStreakUI()
}

/* ---------- User UI ---------- */
function renderUserInfo(){
  const users = loadUsers()
  const cur = users.find(u=>u.id===getCurrentId())
  if(!cur) return
  myAvatar.innerHTML = cur.avatar && cur.avatar.startsWith('data:') ? `<img src="${cur.avatar}" style="width:44px;height:44px;border-radius:50%" />` : cur.avatar
  myName.textContent = cur.name
  myGender.textContent = cur.gender === 'male' ? 'Nam' : 'Ná»¯'
}

/* ---------- Streak UI & logic ---------- */

function updateStreakUI(){
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  if(!me) return
  const hasFriend = (me.friends && me.friends.length>0)
  // locked if no friend
  if(!hasFriend){
    lockedMsg.style.display='block'
    checkinBtn.disabled = true
    invitePlus.style.display = 'inline-block'
  } else {
    lockedMsg.style.display='none'
    checkinBtn.disabled = false
    invitePlus.style.display = 'inline-block'
  }
  // progress fill
  const percent = Math.min(100, (me.streak % 10) * 10)
  progressEl.style.width = percent + '%'
  // color fire
  if(me.streak>0 && me.streak % 10 === 0){ fireEl.style.color = 'green' } else { fireEl.style.color = '#ff7a00' }
  streakText.textContent = `Streak: ${me.streak} ngÃ y`
  // friends list
  friendsList.innerHTML = ''
  (me.friends || []).forEach(fid=>{
    const fu = users.find(u=>u.id===fid)
    if(!fu) return
    const div = document.createElement('div'); div.className='user-row'
    div.innerHTML = `<div class="avatar">${fu.avatar && fu.avatar.startsWith('data:') ? `<img src="${fu.avatar}" style="width:44px;height:44px;border-radius:50%" />` : fu.avatar}</div>
      <div class="flex"><div style="font-weight:600">${fu.name}</div><div class="muted small">Streak: ${fu.streak} ngÃ y</div></div>`
    friendsList.appendChild(div)
  })
  // check message about last checkin or lock time remaining
  if(me.lastCheckin && me.lastCheckin>0){
    const diff = now() - me.lastCheckin
    const remain = 24*60*60*1000 - diff
    if(remain>0) checkinMsg.textContent = `â³ Báº¡n Ä‘Ã£ Ä‘iá»ƒm danh. CÃ³ thá»ƒ Ä‘iá»ƒm danh tiáº¿p sau ${msToHuman(remain)}`
    else checkinMsg.textContent = ''
  } else {
    checkinMsg.textContent = 'Báº¡n chÆ°a Ä‘iá»ƒm danh láº§n nÃ o'
  }
  // update notif badge
  updateNotifBadge()
}

/* convert ms to readable */
function msToHuman(ms){
  const h = Math.floor(ms/3600000); const m = Math.floor((ms%3600000)/60000)
  return `${h} giá» ${m} phÃºt`
}

/* Check if current can check in (for him) - must wait 24h from his lastCheckin */
function canCheckinSelf(me){
  if(!me.lastCheckin) return true
  return (now() - me.lastCheckin) >= 24*60*60*1000
}

/* On checkin */
checkinBtn.addEventListener('click', ()=>{
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  if(!me) return alert('Lá»—i user')
  if(me.friends.length===0) return alert('Vui lÃ²ng má»i Ã­t nháº¥t 1 ngÆ°á»i')
  if(!canCheckinSelf(me)) return alert('Báº¡n pháº£i chá» 24 giá» má»›i Ä‘iá»ƒm danh tiáº¿p')
  // success: add streak for self
  me.streak = (me.streak||0) + 1
  me.lastCheckin = now()
  saveUsers(users)
  updateStreakUI()
  alert(`ğŸ‰ Báº¡n Ä‘Ã£ Ä‘iá»ƒm danh! Streak hiá»‡n táº¡i: ${me.streak} ngÃ y`)
  // set partner windows: partner has 10 hours to checkin or will lose 1 day when check happens
  // We will record a pending window record on each friend: invites? we'll reuse a 'pendingWindow' array on friend
  me.friends.forEach(fid=>{
    const friend = users.find(u=>u.id===fid)
    if(!friend) return
    friend.pendingWindow = friend.pendingWindow || []
    friend.pendingWindow.push({from:me.id,endsAt: now() + 10*3600000}) // 10 hours
  })
  saveUsers(users)
})

/* Periodic check for expired windows and apply penalty if friend didn't check in before end.
   For demo we run this when app loads or when user interacts; this is not a server cron.
*/
function processExpiredWindows(){
  const users = loadUsers(); let changed=false
  users.forEach(u=>{
    if(u.pendingWindow && u.pendingWindow.length){
      const nowt = now()
      const remaining = []
      u.pendingWindow.forEach(w=>{
        if(nowt > w.endsAt){
          // expired -> penalize (reduce streak by 1 for the owner of the related streak) - note: spec says "your friend will lose 1 day"
          // We'll reduce the friend's streak (the owner who created window) OR the invited? Spec: "if friend doesn't checkin will be reduced 1 day and show notification"
          // We'll show notificaton to invited user and decrease the other user's streak? To keep behavior, we will reduce invited user's own streak by 1 (can't be negative).
          const owner = users.find(x => x.id === w.from)
          if(owner){
            // owner may not be penalized; instead we mark a notification to the invited
            u.notifications = u.notifications || []
            u.notifications.push({type:'missed',from:w.from, message:`Báº¡n Ä‘Ã£ bá»‹ tá»¥t 1 ngÃ y vÃ¬ khÃ´ng Ä‘iá»ƒm danh trong 10 tiáº¿ng cá»§a ${owner.name}`})
            u.streak = Math.max(0, (u.streak||0) - 1)
            changed = true
          }
        } else {
          remaining.push(w)
        }
      })
      u.pendingWindow = remaining
    }
  })
  if(changed) saveUsers(users)
}

/* ---------- Invitations & Notifications ---------- */

notifBtn.addEventListener('click', ()=>{
  const id = getCurrentId(); if(!id) return
  openNotifications()
})

function openNotifications(){
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  if(!me) return
  const invites = me.invites || []
  const notifs = me.notifications || []
  let html = `<h3>ThÃ´ng bÃ¡o</h3>`
  if(invites.length===0 && notifs.length===0) html += `<div class="muted">KhÃ´ng cÃ³ thÃ´ng bÃ¡o</div>`
  invites.forEach(inv=>{
    const fromUser = users.find(u=>u.id===inv.from)
    html += `<div style="margin-top:8px" class="row-between">
      <div><strong>${fromUser?fromUser.name:'Ai Ä‘Ã³'}</strong> má»i báº¡n tham gia streak</div>
      <div>
        <button class="ghost" onclick="handleInvite('${inv.from}','accept')">Cháº¥p nháº­n</button>
        <button class="ghost" onclick="handleInvite('${inv.from}','reject')">Tá»« chá»‘i</button>
      </div>
    </div>`
  })
  notifs.forEach((n,idx)=>{
    html += `<div style="margin-top:8px">${n.message} <div class="small-muted"> </div>
      <div style="text-align:right"><button class="ghost" onclick="clearNotification(${idx})">ÄÃ£ xem</button></div></div>`
  })
  html += `<div style="height:12px"></div><div style="text-align:right"><button class="primary" onclick="closeModal()">ÄÃ³ng</button></div>`
  showModal(html)
}

window.handleInvite = function(fromId,action){
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  if(!me) return
  if(action==='accept'){
    // add each other as friends
    if(!me.friends) me.friends = []
    if(!me.friends.includes(fromId)) me.friends.push(fromId)
    const from = users.find(u=>u.id===fromId)
    if(from){
      from.friends = from.friends || []
      if(!from.friends.includes(me.id)) from.friends.push(me.id)
      // remove pending invite from sender side (not stored) - but remove invite from me
    }
    // notify owner that invite accepted (optional)
    // remove invite
    me.invites = (me.invites||[]).filter(x=>x.from!==fromId)
    saveUsers(users)
    alert('Báº¡n Ä‘Ã£ cháº¥p nháº­n lá»i má»i! Chuá»—i Ä‘Æ°á»£c má»Ÿ khÃ³a.')
    closeModal()
    renderApp()
  } else {
    me.invites = (me.invites||[]).filter(x=>x.from!==fromId)
    saveUsers(users)
    closeModal()
    renderApp()
  }
}

window.clearNotification = function(idx){
  const users = loadUsers(), me = users.find(u=>u.id===getCurrentId())
  if(!me) return
  me.notifications = me.notifications || []
  me.notifications.splice(idx,1)
  saveUsers(users)
  renderApp()
  openNotifications()
}

/* Invite flow: show suggestions (other users except me and friends), and let invite */
function renderSuggestions(){
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  suggestionsEl.innerHTML = ''
  users.forEach(u=>{
    if(u.id===me.id) return
    // skip if already friend or already invited
    const isFriend = (me.friends||[]).includes(u.id)
    const invited = (u.invites||[]).some(iv=>iv.from===me.id) // we check other side
    const div = document.createElement('div'); div.className='user-row'
    div.innerHTML = `<div class="avatar">${u.avatar && u.avatar.startsWith('data:') ? `<img src="${u.avatar}" style="width:44px;height:44px;border-radius:50%" />` : u.avatar}</div>
      <div class="flex"><div style="font-weight:600">${u.name}</div><div class="muted small">Streak: ${u.streak || 0} ngÃ y</div></div>
      <div class="right"></div>`
    const right = div.querySelector('.right')
    if(isFriend) right.innerHTML = `<span class="small-muted">ÄÃ£ lÃ  báº¡n</span>`
    else {
      const btn = document.createElement('button'); btn.className='primary'; btn.textContent='Má»i'
      btn.onclick = ()=>{ sendInvite(u.id) }
      right.appendChild(btn)
    }
    suggestionsEl.appendChild(div)
  })
}

/* send invite: push to target user's invites[] */
function sendInvite(targetId){
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  const target = users.find(u=>u.id===targetId)
  if(!target) return alert('KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng')
  target.invites = target.invites || []
  // prevent dup
  if(target.invites.some(iv=>iv.from===me.id)) return alert('Báº¡n Ä‘Ã£ má»i ngÆ°á»i nÃ y rá»“i')
  target.invites.push({from:me.id,at:now()})
  saveUsers(users)
  alert('ÄÃ£ gá»­i lá»i má»i!')
  renderApp()
}

/* render my friends list in explore */
function renderFriends(){
  const users = loadUsers()
  const me = users.find(u=>u.id===getCurrentId())
  myFriendsEl.innerHTML = ''
  (me.friends||[]).forEach(fid=>{
    const fu = users.find(u=>u.id===fid)
    if(!fu) return
    const div = document.createElement('div'); div.className='user-row'
    div.innerHTML = `<div class="avatar">${fu.avatar && fu.avatar.startsWith('data:') ? `<img src="${fu.avatar}" style="width:44px;height:44px;border-radius:50%" />` : fu.avatar}</div>
      <div class="flex"><div style="font-weight:600">${fu.name}</div><div class="muted small">Streak: ${fu.streak || 0} ngÃ y</div></div>`
    myFriendsEl.appendChild(div)
  })
}

/* Leaderboard */
function renderLeaderboard(){
  const users = loadUsers().slice().sort((a,b)=> (b.streak||0) - (a.streak||0))
  leaderboardEl.innerHTML = ''
  users.slice(0,10).forEach((u,i)=>{
    const div = document.createElement('div'); div.className='user-row'
    div.innerHTML = `<div style="width:28px;text-align:center;font-weight:700">${i+1}</div>
      <div class="avatar">${u.avatar && u.avatar.startsWith('data:') ? `<img src="${u.avatar}" style="width:44px;height:44px;border-radius:50%" />` : u.avatar}</div>
      <div class="flex"><div style="font-weight:600">${u.name}</div><div class="muted small">Streak: ${u.streak || 0} ngÃ y</div></div>`
    leaderboardEl.appendChild(div)
  })
}

/* Settings modal */
openSettings.addEventListener('click', ()=>{
  const users = loadUsers(), me = users.find(u=>u.id===getCurrentId())
  if(!me) return
  const html = `<h3>CÃ i Ä‘áº·t</h3>
  <label>Äá»•i tÃªn</label><input id="setName" value="${me.name}" />
  <label>Äá»•i máº­t kháº©u</label><input id="setPass" value="${me.pass}" />
  <label>Giá»›i tÃ­nh</label>
  <select id="setGender">
    <option value="male" ${me.gender==='male'?'selected':''}>Nam</option>
    <option value="female" ${me.gender==='female'?'selected':''}>Ná»¯</option>
  </select>
  <div style="height:10px"></div>
  <div class="row" style="justify-content:flex-end"><button class="primary" id="saveSet">LÆ°u</button></div>
  <div style="height:8px"></div>
  <div style="text-align:right"><button class="ghost" onclick="closeModal()">ÄÃ³ng</button></div>`
  showModal(html)
  document.getElementById('saveSet').addEventListener('click', ()=>{
    const users = loadUsers(), me = users.find(u=>u.id===getCurrentId())
    me.name = document.getElementById('setName').value || me.name
    me.pass = document.getElementById('setPass').value || me.pass
    me.gender = document.getElementById('setGender').value
    saveUsers(users)
    closeModal(); renderApp()
  })
})

/* invite plus button behavior: open suggestions modal or direct listing */
invitePlus.addEventListener('click', ()=>{
  const users = loadUsers(), me = users.find(u=>u.id===getCurrentId())
  let html = `<h3>Má»i báº¡n</h3>`
  const list = users.filter(u=>u.id!==me.id && !(me.friends||[]).includes(u.id))
  if(list.length===0) html += `<div class="muted">KhÃ´ng cÃ³ ngÆ°á»i nÃ o Ä‘á»ƒ má»i</div>`
  list.forEach(u=>{
    html += `<div class="user-row" style="display:flex;align-items:center;gap:12px;margin-top:8px">
      <div class="avatar">${u.avatar && u.avatar.startsWith('data:')?'<img src="'+u.avatar+'" style="width:44px;height:44px;border-radius:50%"/>':u.avatar}</div>
      <div><div style="font-weight:600">${u.name}</div><div class="muted small">Streak: ${u.streak||0} ngÃ y</div></div>
      <div style="margin-left:auto"><button class="primary" onclick='sendInvite("${u.id}")'>Má»i</button></div>
    </div>`
  })
  html += `<div style="height:12px"></div><div style="text-align:right"><button class="ghost" onclick="closeModal()">ÄÃ³ng</button></div>`
  showModal(html)
})

/* Process expired windows on load (apply penalties & create notifications) */
processExpiredWindows()

/* update UI periodic */
setInterval(()=>{ processExpiredWindows(); renderApp() }, 60*1000) // every minute for demo

/* initial render */
renderApp()

/* small helper to allow sendInvite from modal inline functions to call global */
window.sendInvite = function(targetId){
  // close modal then call function
  closeModal()
  sendInvite(targetId)
}

/* Also handle file upload in register: already handled in registration logic */
</script>

</body>
</html>
